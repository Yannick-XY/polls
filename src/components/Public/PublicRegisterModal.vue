<!--
  - SPDX-FileCopyrightText: 2018 Nextcloud contributors
  - SPDX-License-Identifier: AGPL-3.0-or-later
-->

<template>
	<div class="modal__content">
		<div class="modal__registration">
			<div class="registration__registration">
				<h2>{{ t('polls', 'Guest participants') }}</h2>
				<InputDiv v-model="userName"
					class="section__username"
					:signaling-class="checkStatus.userName"
					:placeholder="t('polls', 'Enter your name or a nickname')"
					:helper-text="userNameHint"
					focus
					@submit="submitRegistration" />

				<InputDiv v-if="shareStore.publicPollEmail !== 'disabled'"
					v-model="emailAddress"
					class="section__email"
					:signaling-class="checkStatus.email"
					:placeholder="t('polls', shareStore.publicPollEmail === 'mandatory' ? 'Email address (mandatory)' : 'Email address (optional)')"
					:helper-text="emailAddressHint"
					type="email"
					inputmode="email"
					@submit="submitRegistration" />

				<NcCheckboxRadioSwitch v-if="shareStore.user.type === 'public'" v-model="saveCookie">
					{{ t('polls', 'Remember me for 30 days') }}
				</NcCheckboxRadioSwitch>

				<div v-if="sessionStore.appSettings.usePrivacyUrl" class="section__optin">
					<NcRichText :text="privacyRich.subject" :arguments="privacyRich.parameters" />
				</div>

				<div class="modal__buttons">
					<div class="left">
						<div class="legal_links">
							<SimpleLink v-if="sessionStore.appSettings.useImprintUrl"
								:href="sessionStore.appSettings.useImprintUrl"
								target="_blank"
								:name="t('polls', 'Legal Notice')" />
						</div>
					</div>
					<div class="right">
						<NcButton @click="closeModal">
							<template #default>
								{{ t('polls', 'Cancel') }}
							</template>
						</NcButton>

						<NcButton type="primary" :disabled="disableSubmit" @click="submitRegistration()">
							<template #default>
								{{ t('polls', 'OK') }}
							</template>
						</NcButton>
					</div>
				</div>
			</div>

			<div v-if="sessionStore.appSettings.useLogin" class="registration__login">
				<h2> {{ t('polls', 'Registered accounts') }} </h2>
				<NcButton wide @click="login()">
					<template #default>
						{{ t('polls', 'Login') }}
					</template>
				</NcButton>
				<div>
					{{ t('polls', 'You can also log in and participate with your regular account.') }}
				</div>
				<div>
					{{ t('polls', 'Otherwise participate as a guest participant.') }}
				</div>
			</div>
		</div>
	</div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { debounce } from 'lodash'
import { showError } from '@nextcloud/dialogs'
import { generateUrl } from '@nextcloud/router'
import { NcButton, NcCheckboxRadioSwitch, NcRichText } from '@nextcloud/vue'
import { InputDiv } from '../Base/index.js'
import { SimpleLink, setCookie } from '../../helpers/index.js'
import { ValidatorAPI, PublicAPI } from '../../Api/index.js'
import { t } from '@nextcloud/l10n'
import { useShareStore } from '../../stores/share.ts'
import { useSessionStore } from '../../stores/session.ts'
import { usePollStore } from '../../stores/poll.ts'

const route = useRoute()
const router = useRouter()

const shareStore = useShareStore()
const sessionStore = useSessionStore()
const pollStore = usePollStore()

const COOKIE_LIFETIME = 30
const checkStatus = ref({
	email: 'empty',
	userName: 'empty',
})

const sendRegistration = ref(false)
const userName = ref('')
const emailAddress = ref('')
const redirecting = ref(false)
const saveCookie = ref(true)

const registrationIsValid = computed(() => checkStatus.value.userName === 'valid' && (checkStatus.value.email === 'valid' || (emailAddress.value.length === 0 && shareStore.publicPollEmail !== 'mandatory')))
const disableSubmit = computed(() => !registrationIsValid.value || checkStatus.value.userName === 'checking' || sendRegistration.value)
const emailGeneratedStatus = computed(() => checkStatus.value.email === 'empty' ? shareStore.publicPollEmail : checkStatus.value.email)

const privacyRich = computed(() => {
	const subject = t('polls', 'By clicking the "OK" button you accept our {privacyPolicy}.')
	const parameters = {
		privacyPolicy: {
			component: SimpleLink,
			props: {
				href: sessionStore.appSettings.usePrivacyUrl,
				name: t('polls', 'privacy policy'),
				target: '_blank',
			},
		},
	}
	return { subject, parameters }
})

const loginLink = computed(() => {
	const redirectUrl = this.$router.resolve({
		name: 'publicVote',
		params: { token: this.$route.params.token },
	}).href

	return `${generateUrl('/login')}?redirect_url=${redirectUrl}`
})

const userNameHint = computed(() => {
	if (checkStatus.value.userName === 'checking') return t('polls', 'Checking name …')
	if (checkStatus.value.userName === 'empty') return t('polls', 'A name is required.')
	if (checkStatus.value.userName === 'invalid') return t('polls', 'The name {username} is invalid or reserved.', { username: userName.value })
	return ''
})


const emailAddressHint = computed(() => {
	if (emailGeneratedStatus.value === 'checking') return t('polls', 'Checking email address …')
	if (emailGeneratedStatus.value === 'mandatory') return t('polls', 'An email address is required.')
	if (emailGeneratedStatus.value === 'invalid') return t('polls', 'Invalid email address.')
	if (shareStore.user.type === 'public') {
		if (emailGeneratedStatus.value === 'valid') return t('polls', 'You will receive your personal link after clicking "OK".')
		return t('polls', 'Enter your email address to get your personal access link.')
	}
	return ''
})

onMounted(() => {
	if (route.name === 'publicVote' && route.query.name) {
		userName.value = route.query.name
	} else {
		userName.value = shareStore.user.displayName
	}
	if (route.name === 'publicVote' && route.query.email) {
		emailAddress.value = route.query.email
	} else {
		emailAddress.value = shareStore.user.emailAddress
	}
})

/**
 *
 * @param {string} token - token of the poll
 */
function routeToPersonalShare(token) {
	if (route.params.token === token) {
		// if share was not a public share, but a personal share
		// (i.error. email shares allow to change personal data by fist entering of the poll),
		// just load the poll
		pollStore.get()
		closeModal()
	} else {
		// in case of a public share, redirect to the generated share
		redirecting.value = true
		router.replace({ name: 'publicVote', params: { token } })
		closeModal()
	}
}

/**
 *
 * @param {string} value - value to be stored in the cookie
 */
function updateCookie(value) {
	const cookieExpiration = (COOKIE_LIFETIME * 24 * 60 * 1000)
	setCookie(route.params.token, value, cookieExpiration)
}

/**
 *
 */
function closeModal() {
	this.$emit('close')
}

/**
 *
 */
function login() {
	window.location.assign(`${window.location.protocol}//${window.location.host}${loginLink.value}`)
}

/**
 *
 */
function validatePublicUsername() {
	debounce(async function() {
		if (userName.value.length < 1) {
			checkStatus.value.userName = 'empty'
			return
		}

		checkStatus.value.userName = 'checking'
		try {
			await ValidatorAPI.validateName(route.params.token, userName.value)
			checkStatus.value.userName = 'valid'
		} catch (error) {
			if (error?.code === 'ERR_CANCELED') return
			if (error?.code === 'ERR_BAD_REQUEST') {
				checkStatus.value.userName = 'invalid'
				return
			}
			throw error
		}
	}, 500)
}

/**
 *
 */
function validateEmailAddress() {
	debounce(async function() {
		if (emailAddress.value.length < 1) {
			checkStatus.value.email = 'empty'
			return
		}

		checkStatus.value.email = 'checking'
		try {
			await ValidatorAPI.validateEmailAddress(emailAddress.value)
			checkStatus.value.email = 'valid'
		} catch (error) {
			if (error?.code === 'ERR_CANCELED') return
			if (error?.code === 'ERR_BAD_REQUEST') {
				checkStatus.value.email = 'invalid'
				return
			}
			throw error
		}
	}, 500)
}

/**
 *
 */
async function submitRegistration() {
	if (!registrationIsValid.value || sendRegistration) {
		return
	}

	sendRegistration.value = true

	try {
		const response = await PublicAPI.register(
			route.params.token,
			userName.value,
			emailAddress.value,
		)

		if (saveCookie.value && route.name === 'publicVote') {
			updateCookie(response.data.shareStore.token)
		}

		routeToPersonalShare(response.data.shareStore.token)

		if (shareStore.user.emailAddress && !shareStore.invitationSent) {
			showError(t('polls', 'Email could not be sent to {emailAddress}', { emailAddress: this.shareStore.user.emailAddress }))
		}
	} catch (error) {
		if (error?.code === 'ERR_CANCELED') return
			showError(t('polls', 'Error registering to poll', { error }))
			throw error
	} finally {
		this.sendRegistration = false
	}
}

watch(userName, () => {
	validatePublicUsername()
})

watch(emailAddress, () => {
	validateEmailAddress()
})
</script>

<style lang="scss">
.section__optin {
	a {
		text-decoration: underline;
	}
}

.modal__registration {
	display: flex;
	flex-wrap: wrap;
	overflow: hidden;
	&>div {
		display: flex;
		flex-direction: column;
		flex: 1 auto;
		min-width: 140px;
		padding: 24px;
		border-top: 1px solid;
		border-right: 1px solid;
		margin-top: -2px;
		margin-right: -2px;
		> button {
			margin: 8px 0;
		}
	}

	.registration__login {
		flex: 1 180px;
	}
	.registration__registration {
		flex: 1 480px;

	}
}

[class*='section__'] {
	margin: 4px 0;
}

.modal__content {
	.enter__name, .enter__email {
		margin-bottom: 12px;
	}
}

.legal_links {
	a {
		color: var(--color-text-maxcontrast);
		font-weight: bold;
		white-space: nowrap;
		padding: 10px;
		margin: -10px;

		&:hover, &:active {
			color: var(--color-main-text);
			&::after {
				color: var(--color-text-maxcontrast);
			}
		}

		&:after {
			content:"|";
			padding: 0 4px;
		}

		&:last-child:after {
			content:"";
		}
	}
}
</style>
